/* * Copyright (c) 2011 by Solidus * This file is part of Arsenal library tools source code. * * Permission to use, copy, modify, distribute and sell this software * and its documentation for any purpose is hereby granted without fee, * provided that the above copyright notice appear in all copies and * that both that copyright notice and this permission notice appear * in supporting documentation.It is provided "as is" without express  * or implied warranty. * */#import "GrammarDesignerDocument.h"@implementation GrammarDesignerDocument/****************************Internal************************/-(void)on_reset_timer : (NSInteger)milliseconds{		if(grammarCheckTimer != nil)		{				[grammarCheckTimer invalidate];				//[grammarCheckTimer release];				grammarCheckTimer = nil;		}				if(milliseconds > 0)		{							grammarCheckTimer = [NSTimer scheduledTimerWithTimeInterval	 : (double)milliseconds / 1000.0																	  target : self																	selector : @selector(onGrammarChecker:)																	userInfo : nil																	 repeats : YES									 ];				//[grammarCheckTimer retain];										}		}/****************************Initialize************************/- (id)init{		self = [super init];		if (self) {								grammarContent = [[NSString alloc] init];								NSNotificationCenter *nc = [NSNotificationCenter defaultCenter];				[nc addObserver : self					   selector : @selector(handleParserChanged:)						   name : NOTIFICATION_PREFERENCE_PARSER_CHANGED						 object : nil				 ];												[nc addObserver : self					   selector : @selector(handleFontChanged:)						   name : NOTIFICATION_PREFERENCE_FONT_CHANGED						 object : nil				 ];												[nc addObserver : self					   selector : @selector(handleLexerChanged:)						   name : NOTIFICATION_PREFERENCE_LEXER_CHANGED						 object : nil				 ];								[nc addObserver : self					   selector : @selector(handleApplicationChanged:)						   name : NOTIFICATION_PREFERENCE_APPLICATION_CHANGED						 object : nil				 ];												NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];				NSInteger interval = (NSInteger)[defaults doubleForKey : PREFERENCE_BUILD_TAGS_INTERVAL];				[self on_reset_timer : interval];						}		return self;}-(void)dealloc{		[self on_reset_timer : 0];				NSNotificationCenter *nc = [NSNotificationCenter defaultCenter];		[nc removeObserver : self];				[grammarContent release];		grammarContent = nil;				[super dealloc];}-(void)close{		[self on_reset_timer : 0];		[super close];}- (NSString *)windowNibName{		return @"GrammarDesignerDocument";}- (void)windowControllerDidLoadNib:(NSWindowController *) aController{		[super windowControllerDidLoadNib:aController];		// Add any code here that needs to be executed once the windowController has loaded the document's window.}- (NSData *)dataOfType:(NSString *)typeName error:(NSError **)outError{				return [grammarContent dataUsingEncoding : NSUTF8StringEncoding];}- (BOOL)readFromData:(NSData *)data ofType:(NSString *)typeName error:(NSError **)outError{		BOOL ret = YES;		DLog(@"data length == %d", [data length]);				size_t len = [data length];								arBuffer_t *buf = AR_CreateBuffer(len);		arString_t *str = AR_CreateString();		AR_InsertBuffer(buf, (const byte_t*)[data bytes], len);				if(AR_LoadBomTextFromBinary(buf, NULL, str))		{								[grammarContent release];				grammarContent = [ARUtility convertUTF32ToNSString : AR_GetStringCString(str)];				[grammarContent retain];				DLog(@"%@", grammarContent);				ret = YES;						}else		{				ret = NO;				if(outError)				{						*outError = [NSError errorWithDomain : NSFilePathErrorKey														code : 0													userInfo : nil									 ];				}		}				AR_DestroyBuffer(buf);		AR_DestroyString(str);		buf = NULL;		str = NULL;				return ret;}/****************************Timer Callback************************/- (void)onGrammarChecker:(NSTimer*)theTimer{		DLog(@"GrammarDesignerDocument::onGrammarChecker for timer %@", theTimer);}/********************************************Notification*********************/-(void)handleFontChanged : (NSNotification*)note{		DLog(@"GrammarDesignerDocument::handleFontChanged for notification %@", note);				}-(void)handleLexerChanged : (NSNotification*)note{		DLog(@"GrammarDesignerDocument::handleLexerChanged for notification %@", note);				}-(void)handleParserChanged : (NSNotification*)note{		DLog(@"GrammarDesignerDocument::handleParserChanged for notification %@", note);				NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];		NSInteger interval = (NSInteger)[defaults doubleForKey : PREFERENCE_BUILD_TAGS_INTERVAL];		[self on_reset_timer : interval];		}-(void)handleApplicationChanged : (NSNotification*)note{		DLog(@"GrammarDesignerDocument::handleApplicationChanged for notification %@", note);		}/***************************************************Action********************************/-(IBAction)setDocumentLexerSingleLine : (id)sender{		DLog(@"On GrammarDesignerDocument::setDocumentLexerSingleLine");}-(IBAction)setDocumentLexerIgnoreCase : (id)sender{		DLog(@"On GrammarDesignerDocument::setDocumentLexerIgnoreCase");}-(IBAction)setDocumentParserModeSLR : (id)sender{		DLog(@"On GrammarDesignerDocument::setDocumentParserModeSLR");}-(IBAction)setDocumentParserModeLALR : (id)sender{		DLog(@"On GrammarDesignerDocument::setDocumentParserModeLALR");}-(IBAction)buildDocumentParser	:	(id)sender{		DLog(@"On GrammarDesignerDocument::buildDocumentParser");}-(IBAction)parseDocumentInput	:	(id)sender{		DLog(@"On GrammarDesignerDocument::parseDocumentInput");}-(IBAction)rebuildDocumentTags	:	(id)sender{		DLog(@"On GrammarDesignerDocument::rebuildDocumentTags");}-(IBAction)generateDocumentGrammarTemplateCode : (id)sender{		DLog(@"On GrammarDesignerDocument::generateDocumentGrammarTemplateCode");}#if(0)- (id)init{		DLog(@"On GrammarDesignerDocument::init");		self = [super init];		if (self) {																																						}		return self;}#endif@end